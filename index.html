<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Environmental Data Visualizations</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid black;
            border-radius: 5px;
            padding: 5px;
            visibility: hidden;
        }
    </style>
</head>
<>
    <h1>Global Environmental Data Visualizations</h1>
    <h2>Assignment 1 - Dario Onsori</h2>

    <!-- Data at a Glance Section -->
    <section id="data-at-glance">
        <h3>Data at a Glance</h3>
        <p>This section presents a quick comparison of CO2 emissions for the year 2018 and the average decade 2010-2020.</p>

        <!-- Selector for choosing between year and decade -->
        <label for="time-period">Select Time Period:</label>
        <select id="time-period">
            <option value="2018">Year: 2018</option>
            <option value="decade">Decade: 2010-2020 (Average)</option>
        </select>

        <div id="bar-chart"></div>
        <div style="margin-top: 10px;">
            <button onclick="sortBars()">Sort by Emissions</button>
        </div>
    </section>

    <!-- Country Comparison Section -->
    <section id="country-comparison">
      <h3>Country Comparison</h3>
      <p>This section compares CO2 emissions per capita for the year 2018 across different regions, highlighting the top 5 countries and an aggregated "Other" category for each region.</p>
        
      <div id="stacked-bar-chart"></div>
    </section>

    <!-- Country Comparison - Small Multiple Section -->
    <section id="country-comparison-multiple">
      <h3>Country Comparison - Small Multiple</h3>
      <p>This section displays the CO2 emissions per capita for the year 2018 for each region using a "small multiple" stacked bar chart. Each region has its own chart showing the top-5 countries and the aggregated "Other" category.</p>

      <!-- Container for the small multiple stacked bar charts -->
      <div id="small-multiples"></div>

    <div class="tooltip" id="tooltip"></div>
    </section>
    
    <!-- Country Comparison - Stacked Bar Chart 100% Section -->
    <section id="country-comparison-100">
        <h3>Country Comparison - Stacked Bar Chart 100%</h3>
        <p>This section shows the CO2 emissions per capita for the year 2018 for each region as a 100% stacked bar chart, displaying the relative proportions of emissions from the top-5 countries and the "Other" category.</p>

        <!-- Container for the 100% stacked bar chart -->
        <div id="stacked-bar-100-chart"></div>
    </section>
    
    <!-- Script for the bar chart for Data at a Glance -->
    <script>
        const data2018 = [
            { country: "China", emissions: 7.3 },
            { country: "Germany", emissions: 9.1 },
            { country: "Italy", emissions: 5.8 },
            { country: "Russia", emissions: 11.8 },
            { country: "USA", emissions: 16.2 }
        ];

        const dataDecade = [
            { country: "China", emissions: 7.15 },
            { country: "Germany", emissions: 9.49 },
            { country: "Italy", emissions: 6.14 },
            { country: "Russia", emissions: 11.50 },
            { country: "USA", emissions: 16.50 }
        ];

        let sortByEmissions = false;

        const tooltip = d3.select("#tooltip");

        function createBarChart(data) {
            d3.select("#bar-chart").selectAll("*").remove();

            const width = 500;
            const height = 300;
            const margin = { top: 20, right: 30, bottom: 40, left: 40 };

            const svg = d3.select("#bar-chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            const x = d3.scaleBand()
                .domain(data.map(d => d.country))
                .range([0, width - margin.left - margin.right])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.emissions)])
                .range([height - margin.top - margin.bottom, 0]);

            svg.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.country))
                .attr("y", d => y(d.emissions))
                .attr("width", x.bandwidth())
                .attr("height", d => height - margin.top - margin.bottom - y(d.emissions))
                .attr("fill", "steelblue")
                .on("mouseover", function(event, d) {
                    tooltip.style("visibility", "visible")
                           .text(`Emissions: ${d.emissions}t`);
                })
                .on("mousemove", function(event) {
                    tooltip.style("top", `${event.pageY - 10}px`)
                           .style("left", `${event.pageX + 10}px`);
                })
                .on("mouseout", function() {
                    tooltip.style("visibility", "hidden");
                });

            svg.append("g")
                .attr("transform", `translate(0, ${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x));
            svg.append("g")
                .call(d3.axisLeft(y));
        }

        function sortBars() {
            sortByEmissions = !sortByEmissions;
            let selectedData = document.getElementById("time-period").value === "2018" ? [...data2018] : [...dataDecade];

            if (sortByEmissions) {
                selectedData.sort((a, b) => b.emissions - a.emissions);
            }
            createBarChart(selectedData);
        }

        createBarChart(data2018);

        d3.select("#time-period").on("change", function() {
            const selectedTime = this.value;
            const selectedData = selectedTime === "2018" ? data2018 : dataDecade;
            createBarChart(selectedData);
        });
    </script>

<!-- Dynamic Year Selection and Chart Update for Country Comparison -->
<script>
  // Load the CSV file for the Country Comparison section
  d3.csv("co-emissions-per-capita.csv").then(data => {
      // Extract and populate year options in the dropdown
      const years = Array.from(new Set(data.map(d => d.Year))).sort();
      const yearSelect = d3.select("#year-select");

      yearSelect.selectAll("option")
          .data(years)
          .enter()
          .append("option")
          .attr("value", d => d)
          .text(d => d);

      // Function to update all Country Comparison charts for the selected year
      function updateCharts(selectedYear) {
          const filteredData = data.filter(d => d.Year == selectedYear);

          // Structure data for the stacked bar chart
          const structuredData = prepareData(filteredData);

          // Call functions to render each chart with the structured data
          renderStackedBarChart(structuredData);
          renderSmallMultipleCharts(structuredData);
          renderStackedBarChart100(structuredData);
      }

      // Function to prepare data by region and select the top-5 countries
      function prepareData(filteredData) {
          const regions = d3.groups(filteredData, d => d.Region);
          return regions.map(([region, countries]) => {
              let topCountries = countries
                  .sort((a, b) => b["Annual CO₂ emissions (per capita)"] - a["Annual CO₂ emissions (per capita)"])
                  .slice(0, 5);
              let otherEmissions = countries
                  .slice(5)
                  .reduce((sum, d) => sum + parseFloat(d["Annual CO₂ emissions (per capita)"]), 0);

              return [
                  ...topCountries.map(d => ({
                      region: region,
                      country: d.Entity,
                      emissions: +d["Annual CO₂ emissions (per capita)"]
                  })),
                  {
                      region: region,
                      country: "Other",
                      emissions: otherEmissions
                  }
              ];
          }).flat();
      }

      // Render functions for each chart type in Country Comparison
      function renderStackedBarChart(data) {
          d3.select("#stacked-bar-chart").selectAll("*").remove();

          const width = 800, height = 400, margin = { top: 20, right: 30, bottom: 40, left: 100 };
          const svg = d3.select("#stacked-bar-chart")
              .append("svg")
              .attr("width", width)
              .attr("height", height)
              .append("g")
              .attr("transform", `translate(${margin.left}, ${margin.top})`);

          const xScale = d3.scaleLinear().domain([0, d3.max(data, d => d.emissions)]).range([0, width - margin.left - margin.right]);
          const yScale = d3.scaleBand().domain(data.map(d => d.region)).range([0, height - margin.top - margin.bottom]).padding(0.2);
          const colorScale = d3.scaleOrdinal(d3.schemeTableau10);

          const groupedData = d3.groups(data, d => d.region);
          groupedData.forEach(([region, values]) => {
              let cumulative = 0;
              values.forEach(d => {
                  svg.append("rect")
                      .attr("y", yScale(region))
                      .attr("x", xScale(cumulative))
                      .attr("width", xScale(d.emissions))
                      .attr("height", yScale.bandwidth())
                      .attr("fill", colorScale(d.country))
                      .on("mouseover", function(event) {
                          d3.select("#tooltip").style("visibility", "visible").text(`${d.country}: ${d.emissions.toFixed(2)} t`);
                      })
                      .on("mousemove", function(event) {
                          d3.select("#tooltip").style("top", `${event.pageY - 10}px`).style("left", `${event.pageX + 10}px`);
                      })
                      .on("mouseout", function() {
                          d3.select("#tooltip").style("visibility", "hidden");
                      });
                  cumulative += d.emissions;
              });
          });

          svg.append("g").call(d3.axisLeft(yScale).tickSizeOuter(0));
          svg.append("g").attr("transform", `translate(0, ${height - margin.top - margin.bottom})`).call(d3.axisBottom(xScale).ticks(5));
      }

      function renderSmallMultipleCharts(data) {
          d3.select("#small-multiples").selectAll("*").remove();

          const margin = { top: 20, right: 20, bottom: 30, left: 60 };
          const width = 300 - margin.left - margin.right;
          const height = 200 - margin.top - margin.bottom;
          const colorScale = d3.scaleOrdinal(d3.schemeTableau10);

          const regions = d3.group(data, d => d.region);
          regions.forEach((values, region) => {
              const svg = d3.select("#small-multiples").append("svg")
                  .attr("width", width + margin.left + margin.right)
                  .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                  .attr("transform", `translate(${margin.left},${margin.top})`);

              svg.append("text").attr("x", width / 2).attr("y", -5).attr("text-anchor", "middle").text(region);

              let cumulative = 0;
              values.forEach(d => {
                  svg.append("rect")
                      .attr("x", cumulative)
                      .attr("width", d.emissions * 2)
                      .attr("height", 30)
                      .attr("fill", colorScale(d.country))
                      .on("mouseover", function(event) {
                          d3.select("#tooltip").style("visibility", "visible").text(`${d.country}: ${d.emissions.toFixed(2)} t`);
                      })
                      .on("mousemove", function(event) {
                          d3.select("#tooltip").style("top", `${event.pageY - 10}px`).style("left", `${event.pageX + 10}px`);
                      })
                      .on("mouseout", function() {
                          d3.select("#tooltip").style("visibility", "hidden");
                      });
                  cumulative += d.emissions * 2;
              });
          });
      }

      function renderStackedBarChart100(data) {
          d3.select("#stacked-bar-100-chart").selectAll("*").remove();

          const width = 800, height = 400, margin = { top: 20, right: 30, bottom: 40, left: 100 };
          const svg = d3.select("#stacked-bar-100-chart")
              .append("svg")
              .attr("width", width)
              .attr("height", height)
              .append("g")
              .attr("transform", `translate(${margin.left}, ${margin.top})`);

          const groupedData = d3.groups(data, d => d.region);
          const colorScale = d3.scaleOrdinal(d3.schemeTableau10);

          groupedData.forEach(([region, values]) => {
              let cumulative = 0;
              let totalEmissions = d3.sum(values, d => d.emissions);

              values.forEach(d => {
                  const percent = (d.emissions / totalEmissions) * 100;
                  svg.append("rect")
                      .attr("y", yScale(region))
                      .attr("x", xScale(cumulative))
                      .attr("width", xScale(percent))
                      .attr("height", yScale.bandwidth())
                      .attr("fill", colorScale(d.country))
                      .on("mouseover", function(event) {
                          d3.select("#tooltip").style("visibility", "visible").text(`${d.country}: ${percent.toFixed(2)}%`);
                      })
                      .on("mousemove", function(event) {
                          d3.select("#tooltip").style("top", `${event.pageY - 10}px`).style("left", `${event.pageX + 10}px`);
                      })
                      .on("mouseout", function() {
                          d3.select("#tooltip").style("visibility", "hidden");
                      });
                  cumulative += percent;
              });
          });

          const yScale = d3.scaleBand().domain(groupedData.map(d => d[0])).range([0, height - margin.top - margin.bottom]).padding(0.2);
          svg.append("g").call(d3.axisLeft(yScale).tickSizeOuter(0));
          const xScale = d3.scaleLinear().domain([0, 100]).range([0, width]);
          svg.append("g").attr("transform", `translate(0, ${height - margin.top - margin.bottom})`).call(d3.axisBottom(xScale).ticks(5).tickFormat(d => d + "%"));
      }

      // Initial rendering
      yearSelect.on("change", function() {
          updateCharts(this.value);
      });

      updateCharts(years[0]); // Set the initial chart to the first available year
  });
</script>

    <!-- Tooltip Div for Hover Information -->
    <div class="tooltip" id="tooltip"></div>

</body>
</html>
