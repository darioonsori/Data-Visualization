<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Environmental Data Visualizations</title>
    <!-- Add D3.js for chart creation -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid black;
            border-radius: 5px;
            padding: 5px;
            visibility: hidden;
        }
    </style>
</head>
<body>
    <!-- Homepage title and subtitle -->
    <h1>Global Environmental Data Visualizations</h1>
    <h2>Assignment 1 - Dario Onsori</h2>

    <!-- Data at a Glance Section -->
    <section id="data-at-glance">
        <h3>Data at a Glance</h3>
        <p>This section presents a quick comparison of CO2 emissions for the year 2018 and the average decade 2010-2020.</p>

        <!-- Selector for choosing between year and decade -->
        <label for="time-period">Select Time Period:</label>
        <select id="time-period">
            <option value="2018">Year: 2018</option>
            <option value="decade">Decade: 2010-2020 (Average)</option>
        </select>

        <!-- Container for the bar chart -->
        <div id="bar-chart"></div>
        
        <!-- Button to toggle sorting -->
        <div style="margin-top: 10px;">
            <button onclick="sortBars()">Sort by Emissions</button>
        </div>
    </section>

    <!-- Country Comparison Section -->
    <section id="country-comparison">
        <h3>Country Comparison</h3>
        <p>This section compares CO2 emissions per capita across different regions, highlighting the top 5 countries and an aggregated "Other" category for each region.</p>
        
        <!-- Container for stacked bar chart -->
        <div id="stacked-bar-chart"></div>
    </section>

    <!-- Tooltip for mouseover display -->
    <div class="tooltip" id="tooltip"></div>

    <!-- Script for the bar chart for Data at a Glance -->
    <script>
        // Data for 2018 in alphabetical order
        const data2018 = [
            { country: "China", emissions: 7.3 },
            { country: "Germany", emissions: 9.1 },
            { country: "Italy", emissions: 5.8 },
            { country: "Russia", emissions: 11.8 },
            { country: "USA", emissions: 16.2 }
        ];

        // Data for decade average (2010-2020) in alphabetical order
        const dataDecade = [
            { country: "China", emissions: 7.15 },
            { country: "Germany", emissions: 9.49 },
            { country: "Italy", emissions: 6.14 },
            { country: "Russia", emissions: 11.50 },
            { country: "USA", emissions: 16.50 }
        ];

        // State variable for sorting
        let sortByEmissions = false;

        // Tooltip setup
        const tooltip = d3.select("#tooltip");

        function createBarChart(data) {
            // Clear any existing SVG
            d3.select("#bar-chart").selectAll("*").remove();

            // Chart settings
            const width = 500;
            const height = 300;
            const margin = { top: 20, right: 30, bottom: 40, left: 40 };

            // Create SVG
            const svg = d3.select("#bar-chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // X-axis scale
            const x = d3.scaleBand()
                .domain(data.map(d => d.country))
                .range([0, width - margin.left - margin.right])
                .padding(0.1);

            // Y-axis scale
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.emissions)])
                .range([height - margin.top - margin.bottom, 0]);

            // Bars with tooltip
            svg.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.country))
                .attr("y", d => y(d.emissions))
                .attr("width", x.bandwidth())
                .attr("height", d => height - margin.top - margin.bottom - y(d.emissions))
                .attr("fill", "steelblue")
                .on("mouseover", function(event, d) {
                    tooltip.style("visibility", "visible")
                           .text(`Emissions: ${d.emissions}t`);
                })
                .on("mousemove", function(event) {
                    tooltip.style("top", `${event.pageY - 10}px`)
                           .style("left", `${event.pageX + 10}px`);
                })
                .on("mouseout", function() {
                    tooltip.style("visibility", "hidden");
                });

            // X and Y axes
            svg.append("g")
                .attr("transform", `translate(0, ${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x));
            svg.append("g")
                .call(d3.axisLeft(y));
        }

        // Sorting function
        function sortBars() {
            sortByEmissions = !sortByEmissions;
            let selectedData = document.getElementById("time-period").value === "2018" ? [...data2018] : [...dataDecade];

            if (sortByEmissions) {
                selectedData.sort((a, b) => b.emissions - a.emissions);
            }
            createBarChart(selectedData);
        }

        // Initialize chart with default year selection
        createBarChart(data2018);

        // Update chart on selector change
        d3.select("#time-period").on("change", function() {
            const selectedTime = this.value;
            const selectedData = selectedTime === "2018" ? data2018 : dataDecade;
            createBarChart(selectedData);
        });
    </script>

    <!-- Script for horizontal stacked bar chart in Country Comparison -->
    <script>
        // Complete dataset for the stacked bar chart
        const stackedData = [
            { Region: "Africa", Country: "Libya", Emissions: 8.339181 },
            { Region: "Africa", Country: "South Africa", Emissions: 7.590512 },
            { Region: "Africa", Country: "Seychelles", Emissions: 5.827153 },
            { Region: "Africa", Country: "Algeria", Emissions: 4.085100 },
            { Region: "Africa", Country: "Equatorial Guinea", Emissions: 4.000027 },
            { Region: "Africa", Country: "Other", Emissions: 31.802244 },
            { Region: "Asia", Country: "Qatar", Emissions: 34.504090 },
            { Region: "Asia", Country: "Kuwait", Emissions: 24.448280 },
            { Region: "Asia", Country: "United Arab Emirates", Emissions: 22.896563 },
            { Region: "Asia", Country: "Bahrain", Emissions: 21.943077 },
            { Region: "Asia", Country: "Brunei", Emissions: 21.516985 },
            { Region: "Asia", Country: "Other", Emissions: 179.133522 },
            { Region: "Europe", Country: "Kazakhstan", Emissions: 16.569881 },
            { Region: "Europe", Country: "Luxembourg", Emissions: 15.748627 },
            { Region: "Europe", Country: "Estonia", Emissions: 13.527124 },
            { Region: "Europe", Country: "Russia", Emissions: 11.757415 },
            { Region: "Europe", Country: "Iceland", Emissions: 10.395095 },
            { Region: "Europe", Country: "Other", Emissions: 236.507179 },
            { Region: "North America", Country: "Trinidad and Tobago", Emissions: 26.801151 },
            { Region: "North America", Country: "United States", Emissions: 16.191355 },
            { Region: "North America", Country: "Canada", Emissions: 15.581538 },
            { Region: "North America", Country: "Antigua and Barbuda", Emissions: 6.716774 },
            { Region: "North America", Country: "Bahamas", Emissions: 6.025971 },
            { Region: "North America", Country: "Other", Emissions: 42.077580 },
            { Region: "Oceania", Country: "Australia", Emissions: 16.627844 },
            { Region: "Oceania", Country: "Palau", Emissions: 11.880807 },
            { Region: "Oceania", Country: "New Zealand", Emissions: 7.379144 },
            { Region: "Oceania", Country: "Nauru", Emissions: 4.599548 },
            { Region: "Oceania", Country: "Marshall Islands", Emissions: 3.185256 },
            { Region: "Oceania", Country: "Other", Emissions: 7.366800 },
            { Region: "South America", Country: "Chile", Emissions: 4.515097 },
            { Region: "South America", Country: "Argentina", Emissions: 4.066307 },
            { Region: "South America", Country: "Suriname", Emissions: 3.518976 },
            { Region: "South America", Country: "Venezuela", Emissions: 3.377444 },
            { Region: "South America", Country: "Guyana", Emissions: 3.186389 },
            { Region: "South America", Country: "Other", Emissions: 13.194629 }
        ];

        // Chart settings
        const margin = { top: 20, right: 30, bottom: 40, left: 50 };
        const width = 800 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        // SVG container
        const svg = d3.select("#stacked-bar-chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

        // X and Y scales (flipped for horizontal bars)
        const xScale = d3.scaleLinear()
            .domain([0, d3.max(stackedData, d => d.Emissions)])
            .range([0, width]);

        const yScale = d3.scaleBand()
            .domain(stackedData.map(d => d.Region))
            .range([0, height])
            .padding(0.2);

        // Color scale
        const colorScale = d3.scaleOrdinal(d3.schemeTableau10);

        // Stack data by Region
        const regions = d3.group(stackedData, d => d.Region);
        let processedData = [];
        regions.forEach((values, key) => {
            let total = 0;
            values.forEach(d => {
                processedData.push({ region: key, country: d.Country, emissions: d.Emissions, start: total });
                total += d.Emissions;
            });
        });

        // Draw bars
        svg.selectAll(".bar")
            .data(processedData)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("y", d => yScale(d.region))
            .attr("x", d => xScale(d.start))
            .attr("height", yScale.bandwidth())
            .attr("width", d => xScale(d.emissions))
            .attr("fill", d => colorScale(d.country))
            .on("mouseover", function(event, d) {
                d3.select("#tooltip")
                    .style("visibility", "visible")
                    .text(`${d.country}: ${d.emissions.toFixed(2)} t`);
            })
            .on("mousemove", function(event) {
                d3.select("#tooltip")
                    .style("top", `${event.pageY - 10}px`)
                    .style("left", `${event.pageX + 10}px`);
            })
            .on("mouseout", function() {
                d3.select("#tooltip").style("visibility", "hidden");
            });

        // Y-axis (regions)
        svg.append("g")
            .call(d3.axisLeft(yScale));

        // X-axis (emissions)
        svg.append("g")
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(xScale).ticks(5));
    </script>
</body>
</html>
